<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RFID Attendance — Dashboard</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2b; --muted:#9aa7bf; --accent:#2b9cff; --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#061022 0%, #071428 100%);color:#e6eef8}
    .container{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:20px}
    .logo{width:58px;height:58px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6fc3ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#021224}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:18px}

    /* cards */
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,8,20,0.6);}
    .stat{grid-column:span 3;padding:18px}
    .stat .num{font-size:22px;font-weight:700}
    .stat .label{color:var(--muted);font-size:13px}

    /* big area */
    .big{grid-column:span 8}
    .side{grid-column:span 4;display:flex;flex-direction:column;gap:16px}

    /* iframe */
    .viz{height:420px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
    .last-punch{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
    .lp-name{font-size:18px;font-weight:700}
    .lp-time{color:var(--muted)}

    /* table */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px}
    th{color:var(--muted);font-weight:600}

    /* responsive */
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(1,1fr)}
      .stat{grid-column:span 6}
      .big{grid-column:span 1}
      .side{grid-column:span 1}
      .viz{height:300px}
    }

    .small-muted{color:var(--muted);font-size:12px}
    .spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .footer{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">RF</div>
      <div>
        <h1>RFID Attendance Dashboard</h1>
        <p class="lead">Modern view • Live updates • Parent notifications via ThingSpeak MATLAB</p>
      </div>
    </header>

    <div class="grid">
      <!-- Stats cards -->
      <div class="card stat">
        <div class="small-muted">Total Students</div>
        <div class="num" id="totalStudents">--</div>
      </div>

      <div class="card stat">
        <div class="small-muted">Total Punches Today</div>
        <div class="num" id="punchesToday">--</div>
      </div>

      <div class="card stat">
        <div class="small-muted">Today's First Punch</div>
        <div class="num" id="firstPunch">--</div>
      </div>

      <div class="card stat">
        <div class="small-muted">Today's Last Punch</div>
        <div class="num" id="lastPunch">--</div>
      </div>

      <!-- Main visualization area -->
      <div class="card big">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700">Attendance Graph</div>
          <div class="small-muted">Live (updates every 30s)</div>
        </div>
        <div class="viz">
          <!-- Embed your ThingSpeak MATLAB Visualization iframe here -->
          <iframe id="tsIframe" src="https://thingspeak.com/apps/matlab_visualizations/645434" width="100%" height="100%" frameborder="0" allowtransparency="true"></iframe>
        </div>

        <div style="margin-top:14px">
          <div style="font-weight:700;margin-bottom:8px">Recent punches</div>
          <div style="max-height:220px;overflow:auto">
            <table id="recentTable"><thead><tr><th>Name</th><th>Date</th><th>Time</th></tr></thead><tbody>
              <tr><td colspan="3" class="small-muted">Loading...</td></tr>
            </tbody></table>
          </div>
        </div>
      </div>

      <!-- Right side: last punch card + controls -->
      <div class="side">
        <div class="card last-punch">
          <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
            <div>
              <div class="small-muted">Last Punch</div>
              <div class="lp-name" id="lpName">--</div>
              <div class="lp-time" id="lpTime">--</div>
            </div>
            <div id="statusSpinner" style="display:flex;flex-direction:column;align-items:center;gap:6px">
              <div class="spinner"></div>
              <div class="small-muted" style="font-size:12px">Updating</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">Quick Controls</div>
          <div class="small-muted" style="font-size:13px;line-height:1.5">Use this dashboard locally or host on any static web host. It fetches live data from ThingSpeak and updates every 30 seconds.</div>
        </div>
      </div>

    </div>

    <div class="footer">Tip: If you want the iframe larger on another page, increase width/height in the &lt;iframe&gt; or embed in a wider container.</div>
  </div>

  <script>
    // ------------------ CONFIG ------------------
    const CHANNEL_ID = 3161153;             // your ThingSpeak channel id
    const READ_API_KEY = 'SAIUBKLZROI29ZCZ'; // your read api key
    const RESULTS = 50;                      // how many recent entries to fetch
    const UPDATE_INTERVAL = 30000;          // ms

    // helper - parse dd/MM/yyyy HH:mm:ss into JS Date
    function parseCustomDate(dateStr, timeStr){
      // dateStr = 'dd/MM/yyyy' timeStr = 'HH:mm:ss' or 'H:mm:ss'
      const parts = dateStr.split('/');
      if(parts.length!==3) return null;
      const d = parseInt(parts[0],10), m = parseInt(parts[1],10)-1, y = parseInt(parts[2],10);
      const tparts = timeStr.split(':');
      const hh = parseInt(tparts[0]||0,10), mm = parseInt(tparts[1]||0,10), ss = parseInt(tparts[2]||0,10);
      return new Date(y, m, d, hh, mm, ss);
    }

    async function fetchData(){
      try{
        const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=${RESULTS}`;
        const res = await fetch(url);
        const obj = await res.json();
        return obj.feeds || [];
      }catch(err){
        console.error('Fetch failed',err);
        return [];
      }
    }

    function formatTime(dt){
      if(!dt) return '--';
      // show dd-MMM hh:mm:ss
      const opts = {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit', second:'2-digit'};
      return dt.toLocaleString(undefined,opts);
    }

    function todayStart(){
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    }

    async function updateUI(){
      const feeds = await fetchData();
      const tableBody = document.querySelector('#recentTable tbody');
      tableBody.innerHTML = '';

      if(!feeds.length){
        tableBody.innerHTML = '<tr><td colspan="3" class="small-muted">No data</td></tr>';
        document.getElementById('statusSpinner').style.display='none';
        return;
      }

      // Build rows (reverse to show newest first)
      const rows = feeds.slice().reverse();

      // Stats
      const uniqueStudents = new Set();
      const today = todayStart();
      let punchesToday = 0;
      let firstPunchToday = null;
      let lastPunchToday = null;

      rows.forEach((f, idx) => {
        const name = f.field1 !== undefined ? f.field1 : (f.studentName || f.field_1 || 'Unknown');
        // Some ThingSpeak setups store custom field names; try common ones (field1 or studentName)
        const dateField = f.field2 !== undefined ? f.field2 : (f.date || f.field_2 || '');
        const timeField = f.field3 !== undefined ? f.field3 : (f.time || f.field_3 || '');

        // parse
        const dt = parseCustomDate(dateField, timeField);
        if(name) uniqueStudents.add(name);

        // today's punches
        if(dt && dt >= today){
          punchesToday++;
          if(!firstPunchToday || dt < firstPunchToday) firstPunchToday = dt;
          if(!lastPunchToday || dt > lastPunchToday) lastPunchToday = dt;
        }

        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = name; tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.textContent = dateField; tr.appendChild(td2);
        const td3 = document.createElement('td'); td3.textContent = timeField; tr.appendChild(td3);
        tableBody.appendChild(tr);
      });

      // Fill stats
      document.getElementById('totalStudents').textContent = uniqueStudents.size;
      document.getElementById('punchesToday').textContent = punchesToday;
      document.getElementById('firstPunch').textContent = firstPunchToday ? formatTime(firstPunchToday) : '--';
      document.getElementById('lastPunch').textContent = lastPunchToday ? formatTime(lastPunchToday) : '--';

      // Last punch details (most recent feed is last element in feeds array)
      const last = feeds[feeds.length-1];
      const lastName = last.field1 !== undefined ? last.field1 : (last.studentName || last.field_1 || 'Unknown');
      const lastDate = last.field2 !== undefined ? last.field2 : (last.date || last.field_2 || '');
      const lastTime = last.field3 !== undefined ? last.field3 : (last.time || last.field_3 || '');
      const lastDt = parseCustomDate(lastDate, lastTime);

      document.getElementById('lpName').textContent = lastName;
      document.getElementById('lpTime').textContent = lastDate + ' ' + lastTime + (lastDt ? ' • ' + formatTime(lastDt) : '');

      document.getElementById('statusSpinner').style.display='flex';
    }

    // initial load
    updateUI();
    // periodic refresh
    setInterval(updateUI, UPDATE_INTERVAL);

  </script>
</body>
</html>
